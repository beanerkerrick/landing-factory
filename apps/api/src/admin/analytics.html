<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Landing Factory • Analytics</title>
  <style>
    :root{--bg:#0b1020;--card:#111833;--text:#e7ecff;--muted:#a7b0d6;--border:#243055;--accent:#7c5cff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,textarea,select{background:#0f1630;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px}
    textarea{width:100%;min-height:110px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    button{background:var(--accent);border:0;color:white;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    h1{margin:0 0 4px 0;font-size:22px}
    h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .err{color:#ffb4b4}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; margin-bottom:12px;">
      <div>
        <h1>Landing Factory</h1>
        <div class="muted">Analytics Profiles</div>
      </div>
      <div class="row">
        <a class="tag" href="/admin">Home</a>
        <a class="tag" href="/admin/links">Links</a>
        <a class="tag" href="/admin/themes">Themes</a>
        <a class="tag" href="/admin/autopost">Autopost</a>
      </div>
    </div>

    <div class="card">
      <h2>Admin Token</h2>
      <div class="row">
        <input id="token" placeholder="ADMIN_TOKEN" style="min-width:360px" />
        <button id="save">Save</button>
        <span id="tstatus" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h2>Create Analytics Profile</h2>
      <div class="row">
        <input id="name" placeholder="Profile name" style="min-width:260px" />
        <button id="create">Create</button>
      </div>
      <p class="muted">scriptsJson example: { "head": ["&lt;script&gt;...&lt;/script&gt;"], "body_end": ["..."] }</p>
      <textarea id="scripts" placeholder='{"head":[],"body_end":[]}'></textarea>
      <p class="muted">verificationJson optional: { "google": "...", "bing": "...", "yandex": "..." }</p>
      <textarea id="verification" placeholder='{}'></textarea>
      <div id="createErr" class="err"></div>
    </div>

    <div class="card">
      <h2>Profiles</h2>
      <div id="profiles"></div>
    </div>

    <div class="card">
      <h2>Assign to Site</h2>
      <div class="row">
        <select id="site"></select>
        <select id="profile"></select>
        <button id="assign">Assign</button>
        <button class="secondary" id="unassign">Clear</button>
      </div>
      <div id="assignErr" class="err"></div>
    </div>

  </div>

<script>
  const qs = (s)=>document.querySelector(s);
  const tokenKey = 'lf_admin_token';
  function getToken(){ return localStorage.getItem(tokenKey)||''; }
  function setToken(t){ localStorage.setItem(tokenKey,t); }
  qs('#token').value = getToken();
  qs('#save').onclick = ()=>{ setToken(qs('#token').value.trim()); qs('#tstatus').textContent='saved'; setTimeout(()=>qs('#tstatus').textContent='',1200); };

  async function api(path, opts={}){
    const t = getToken();
    const headers = Object.assign({ 'content-type':'application/json' }, opts.headers||{});
    if(t) headers['X-Admin-Token']=t;
    const res = await fetch(path, Object.assign({}, opts, {headers}));
    if(!res.ok){ throw new Error(await res.text()); }
    return res.json();
  }

  async function load(){
    const [p, s] = await Promise.all([
      api('/analytics/profiles'),
      api('/sites')
    ]);

    // profiles table
    const profDiv = qs('#profiles');
    const rows = p.profiles.map(x=>{
      const scripts = JSON.stringify(x.scriptsJson||{}, null, 0);
      return `<tr><td class="mono">${x.id}</td><td>${x.name}</td><td class="mono">${scripts.replaceAll('<','&lt;')}</td></tr>`;
    }).join('');
    profDiv.innerHTML = `<table><thead><tr><th>ID</th><th>Name</th><th>scriptsJson</th></tr></thead><tbody>${rows}</tbody></table>`;

    // site select
    const siteSel = qs('#site');
    siteSel.innerHTML = s.sites.map(si=>`<option value="${si.id}">${si.domain.domainName} • ${si.theme}</option>`).join('');

    // profile select
    const profileSel = qs('#profile');
    profileSel.innerHTML = `<option value="">(none)</option>` + p.profiles.map(pr=>`<option value="${pr.id}">${pr.name}</option>`).join('');
  }

  qs('#create').onclick = async ()=>{
    qs('#createErr').textContent='';
    try{
      const name = qs('#name').value.trim() || 'Profile';
      const scriptsJson = JSON.parse(qs('#scripts').value || '{"head":[],"body_end":[]}');
      const verificationJson = JSON.parse(qs('#verification').value || '{}');
      await api('/analytics/profiles', { method:'POST', body: JSON.stringify({ name, scriptsJson, verificationJson }) });
      qs('#name').value='';
      await load();
    }catch(e){ qs('#createErr').textContent = String(e); }
  };

  qs('#assign').onclick = async ()=>{
    qs('#assignErr').textContent='';
    try{
      const siteId = qs('#site').value;
      const analyticsProfileId = qs('#profile').value || null;
      await api(`/sites/${siteId}/analytics/assign`, { method:'POST', body: JSON.stringify({ analyticsProfileId }) });
      await load();
    }catch(e){ qs('#assignErr').textContent = String(e); }
  };

  qs('#unassign').onclick = async ()=>{
    qs('#assignErr').textContent='';
    try{
      const siteId = qs('#site').value;
      await api(`/sites/${siteId}/analytics/assign`, { method:'POST', body: JSON.stringify({ analyticsProfileId: null }) });
      await load();
    }catch(e){ qs('#assignErr').textContent = String(e); }
  };

  load().catch(e=>{ qs('#profiles').innerHTML = `<div class="err">${String(e)}</div>`; });
</script>
</body>
</html>
